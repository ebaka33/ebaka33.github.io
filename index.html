<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Bottle Flip Challenge</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è 3D –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Ñ–∏–∑–∏–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tone.js –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º—É–∑—ã–∫–∏ –∏ –∑–≤—É–∫–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>

    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ —Ö–æ–ª—Å—Ç–∞ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
        }
        #game-canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        .ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none; /* –ü–æ–∑–≤–æ–ª—è–µ—Ç –∫–ª–∏–∫–∞—Ç—å "—Å–∫–≤–æ–∑—å" –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –∫–∞–Ω–≤–∞—Å */
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }
        .top-bar, .bottom-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            pointer-events: auto; /* –í–∫–ª—é—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        }
        .bottom-bar {
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .power-bar-container {
            width: 80%;
            max-width: 500px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 2px solid white;
            overflow: hidden;
        }
        #power-bar-slider {
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #ef4444, #f59e0b, #84cc16, #f59e0b, #ef4444); /* –ö—Ä–∞—Å–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤–æ-–∑–µ–ª–µ–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            transform: translateX(-100%);
        }
        .shop-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            background-color: rgba(42, 50, 68, 0.95);
            border-radius: 20px;
            border: 2px solid #4a5568;
            padding: 20px;
            z-index: 10;
            display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
            pointer-events: auto;
            max-height: 80vh;
            overflow-y: auto;
        }
        .shop-button, .close-button, .shop-item button {
             background-color: #4f46e5;
             color: white;
             padding: 10px 20px;
             border-radius: 8px;
             border: none;
             cursor: pointer;
             transition: background-color 0.3s;
             font-weight: bold;
        }
        .shop-button:hover, .close-button:hover, .shop-item button:hover {
            background-color: #6366f1;
        }
        .shop-item.purchased button {
            background-color: #16a34a;
            cursor: default;
        }
         .shop-item.equipped button {
            background-color: #ca8a04;
            border: 2px solid white;
        }
        .message-box {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background-color: rgba(79, 70, 229, 0.9);
            color: white;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.5s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <!-- –ò–≥—Ä–æ–≤–æ–π —Ö–æ–ª—Å—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Ä–∏—Å–æ–≤–∞—Ç—å—Å—è 3D —Å—Ü–µ–Ω–∞ -->
    <canvas id="game-canvas"></canvas>

    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UI) -->
    <div class="ui-container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å: –º–æ–Ω–µ—Ç—ã –∏ –∫–Ω–æ–ø–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ -->
        <div class="top-bar">
            <div id="coin-display" class="bg-black bg-opacity-50 p-3 rounded-xl text-2xl font-bold">üí∞ 0</div>
            <button id="shop-button" class="shop-button">–ú–∞–≥–∞–∑–∏–Ω üõí</button>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å: —à–∫–∞–ª–∞ —Å–∏–ª—ã –±—Ä–æ—Å–∫–∞ -->
        <div class="bottom-bar">
            <p class="text-lg font-semibold">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –±—Ä–æ—Å–∏—Ç—å!</p>
            <div class="power-bar-container">
                <div id="power-bar-slider"></div>
            </div>
        </div>
    </div>
    
    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–û—Ç–ª–∏—á–Ω—ã–π –±—Ä–æ—Å–æ–∫!") -->
    <div id="message-box" class="message-box"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞–≥–∞–∑–∏–Ω–∞ -->
    <div id="shop-modal" class="shop-modal">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">–ú–∞–≥–∞–∑–∏–Ω</h2>
            <button id="close-shop-button" class="close-button text-2xl">&times;</button>
        </div>
        <div id="shop-content" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Ç–æ–≤–∞—Ä—ã –∏–∑ JavaScript -->
        </div>
    </div>

    <script type="module">
        // --- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bottle-flip-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIza...", authDomain: "...", projectId: "..." };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId;
        let userDocRef;
        let unsubscribe; // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—è Firestore

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ì–†–´ ---
        let scene, camera, renderer, world;
        let hand, bottle, bottleBody, bottleCap, water, trajectoryLine;
        let bottlePhysicsBody;
        let platforms = [];
        let coins = 0;
        let gameState = 'ready'; // 'ready', 'throwing', 'landed'
        let powerBarValue = 0;
        let powerBarDirection = 1;

        // --- –ù–ê–°–¢–†–û–ô–ö–ò –ò–ì–†–´ ---
        const powerBarSpeed = 0.03;
        const bottleSwayFactor = 0.05;
        
        // --- –ù–ê–°–¢–†–û–ô–ö–ò –ú–ê–ì–ê–ó–ò–ù–ê ---
        let userItems = {
            skins: ['default'],
            bracelets: ['none'],
            tattoos: ['none'],
            locations: ['park'],
            music: ['default'],
        };
        let activeItems = {
            skin: 'default',
            bracelet: 'none',
            tattoo: 'none',
            location: 'park',
            music: 'default'
        };

        const shopItems = {
            skins: [
                { id: 'default', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è', price: 0 },
                { id: 'red', name: '–ö—Ä–∞—Å–Ω–∞—è –±—É—Ç—ã–ª–∫–∞', price: 100, color: 0xff0000 },
                { id: 'gold', name: '–ó–æ–ª–æ—Ç–∞—è –±—É—Ç—ã–ª–∫–∞', price: 500, color: 0xffd700 },
            ],
            locations: [
                { id: 'park', name: '–ü–∞—Ä–∫', price: 0, background: 'linear-gradient(to top, #6ee7b7, #3b82f6)' },
                { id: 'city', name: '–ì–æ—Ä–æ–¥', price: 300, background: 'linear-gradient(to top, #9ca3af, #374151)' },
            ],
            music: [
                { id: 'default', name: '–°–ø–æ–∫–æ–π–Ω–∞—è –º–µ–ª–æ–¥–∏—è', price: 0 },
                { id: 'synthwave', name: 'Synthwave', price: 200 },
            ]
        };
        
        // --- –ú–£–ó–´–ö–ê –ò –ó–í–£–ö–ò ---
        let music;
        let musicTracks; 
        let currentLoop;

        // --- –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ---
        async function init() {
            musicTracks = {
                'default': () => new Tone.Synth().toDestination(),
                'synthwave': () => new Tone.FMSynth({
                    harmonicity: 3,
                    modulationIndex: 10,
                    envelope: { attack: 0.01, decay: 0.2, release: 0.5 },
                    modulationEnvelope: { attack: 0.01, decay: 0.2, release: 0.5 }
                }).toDestination()
            };

            // 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            await setupAuthAndLoadInitialData();

            // 2. –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–≥—Ä–æ–≤–æ–π –º–∏—Ä
            setupScene();
            setupPhysics();
            createHandAndBottle();
            createPlatforms(activeItems.location);
            createTrajectoryLine();
            setupUI();

            // 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
            animate();
            await Tone.start();
            playMusic(activeItems.music);
        }

        // --- –§–£–ù–ö–¶–ò–ò –ù–ê–°–¢–†–û–ô–ö–ò ---
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–¥–∏–Ω —Ä–∞–∑, –∞ –∑–∞—Ç–µ–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç "—Å–ª—É—à–∞—Ç–µ–ª—å" –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        async function setupAuthAndLoadInitialData() {
            return new Promise((resolve, reject) => {
                const authUnsubscribe = onAuthStateChanged(auth, async (user) => {
                    authUnsubscribe(); // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
                    try {
                        if (user) {
                            userId = user.uid;
                        } else {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser.uid;
                        }
                        console.log("UserID:", userId);
                        userDocRef = doc(db, `artifacts/${appId}/users/${userId}/bottleFlipState/gameState`);

                        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é getDoc
                        const docSnap = await getDoc(userDocRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            coins = data.coins || 0;
                            userItems = data.userItems || userItems;
                            activeItems = data.activeItems || activeItems;
                        } else {
                            console.log("–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π.");
                            await saveGameData(); // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        }

                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –±—É–¥—É—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                        setupRealtimeListener();
                        resolve();

                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
                        reject(error);
                    }
                });
            });
        }

        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    coins = data.coins || 0;
                    userItems = data.userItems || userItems;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ–Ω—É–∂–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                    if (activeItems.skin !== data.activeItems.skin) {
                        equipItem('skins', data.activeItems.skin);
                    }
                    if (activeItems.location !== data.activeItems.location) {
                        equipItem('locations', data.activeItems.location);
                    }
                    if (activeItems.music !== data.activeItems.music) {
                        equipItem('music', data.activeItems.music);
                    }
                    
                    activeItems = data.activeItems;
                    
                    updateCoinDisplay();
                    populateShop();
                }
            });
        }
        
        function setupScene() {
            scene = new THREE.Scene();
            if (activeItems && activeItems.location) {
                const location = shopItems.locations.find(l => l.id === activeItems.location);
                if(location) document.body.style.background = location.background;
            }

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 5);

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game-canvas'), antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
        }

        function setupPhysics() {
            world = new CANNON.World();
            world.gravity.set(0, -9.82, 0);
        }

        function createHandAndBottle() {
            const handMaterial = new THREE.MeshLambertMaterial({ color: 0xdbb491 });
            const handGeometry = new THREE.BoxGeometry(0.5, 0.6, 0.5);
            hand = new THREE.Mesh(handGeometry, handMaterial);
            hand.position.set(0, 1, 3.5);
            scene.add(hand);

            bottle = new THREE.Group();
            
            const bottleMaterial = new THREE.MeshPhysicalMaterial({ color: 0xadd8e6, transparent: true, opacity: 0.7, roughness: 0.1, transmission: 0.9 });
            const bottleBodyGeometry = new THREE.CylinderGeometry(0.15, 0.15, 0.5, 32);
            bottleBody = new THREE.Mesh(bottleBodyGeometry, bottleMaterial);
            
            const capMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff });
            const bottleCapGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.05, 32);
            bottleCap = new THREE.Mesh(bottleCapGeometry, capMaterial);
            bottleCap.position.y = 0.275;

            const waterMaterial = new THREE.MeshPhysicalMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.8, roughness: 0, transmission: 1.0 });
            const waterGeometry = new THREE.CylinderGeometry(0.14, 0.14, 0.3, 32);
            water = new THREE.Mesh(waterGeometry, waterMaterial);
            water.position.y = -0.1;

            bottle.add(bottleBody);
            bottle.add(bottleCap);
            bottle.add(water);
            
            hand.add(bottle);
            bottle.position.set(0, 0.5, 0);

            const bottleShape = new CANNON.Cylinder(0.15, 0.15, 0.6, 32);
            bottlePhysicsBody = new CANNON.Body({
                mass: 1,
                shape: bottleShape,
                position: new CANNON.Vec3(0, 1.5, 3.5),
            });
            world.addBody(bottlePhysicsBody);
        }

        function createPlatforms(locationId) {
            platforms.forEach(p => {
                scene.remove(p.mesh);
                world.removeBody(p.body);
            });
            platforms = [];

            let platformData = [];
            if (locationId === 'park') {
                platformData = [
                    { pos: { x: 0, y: 0, z: -2 }, size: { x: 1, y: 0.1, z: 1 }, color: 0x8B4513 },
                    { pos: { x: -3, y: 0.8, z: -3 }, size: { x: 1.5, y: 0.1, z: 0.5 }, color: 0xA0522D },
                    { pos: { x: 3, y: 1.5, z: -4 }, size: { x: 0.2, y: 0.2, z: 3 }, color: 0x654321 }
                ];
            } else if (locationId === 'city') {
                 platformData = [
                    { pos: { x: 0, y: 0.5, z: -3 }, size: { x: 0.5, y: 1, z: 0.5 }, color: 0x6b7280 },
                    { pos: { x: -2.5, y: 1, z: -5 }, size: { x: 2, y: 0.2, z: 1 }, color: 0x78716c },
                    { pos: { x: 3, y: 1.2, z: -2 }, size: { x: 1, y: 0.1, z: 1 }, color: 0x4b5563 }
                ];
            }

            const groundShape = new CANNON.Plane();
            const groundBody = new CANNON.Body({ mass: 0, shape: groundShape });
            groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
            world.addBody(groundBody);

            platformData.forEach(data => {
                const mesh = new THREE.Mesh(
                    new THREE.BoxGeometry(data.size.x, data.size.y, data.size.z),
                    new THREE.MeshLambertMaterial({ color: data.color })
                );
                mesh.position.set(data.pos.x, data.pos.y, data.pos.z);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                scene.add(mesh);

                const body = new CANNON.Body({
                    mass: 0,
                    shape: new CANNON.Box(new CANNON.Vec3(data.size.x / 2, data.size.y / 2, data.size.z / 2)),
                    position: new CANNON.Vec3(data.pos.x, data.pos.y, data.pos.z),
                });
                world.addBody(body);
                platforms.push({ mesh, body });
            });
        }
        
        function createTrajectoryLine() {
            const material = new THREE.LineBasicMaterial({ color: 0xff0000, linewidth: 2 });
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(20 * 3);
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            trajectoryLine = new THREE.Line(geometry, material);
            trajectoryLine.visible = false;
            scene.add(trajectoryLine);
        }
        
        function setupUI() {
            document.getElementById('shop-button').addEventListener('click', toggleShop);
            document.getElementById('close-shop-button').addEventListener('click', toggleShop);
            updateCoinDisplay();
            populateShop();
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–∫–∏–Ω—ã –∏ —Ç.–¥.
            equipItem('skins', activeItems.skin);
        }

        // --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---

        function onPointerDown() {
            if (gameState === 'ready') {
                throwBottle();
            } else if (gameState === 'landed') {
                resetBottle();
            }
        }

        function throwBottle() {
            gameState = 'throwing';
            trajectoryLine.visible = false;
            
            scene.add(bottle);
            hand.visible = false;

            const forceMagnitude = 2 + powerBarValue * 3;
            const angle = Math.PI / 4;
            
            const impulse = new CANNON.Vec3(0, Math.sin(angle) * forceMagnitude, -Math.cos(angle) * forceMagnitude);
            const worldPoint = new CANNON.Vec3(bottlePhysicsBody.position.x, bottlePhysicsBody.position.y - 0.3, bottlePhysicsBody.position.z);
            bottlePhysicsBody.applyImpulse(impulse, worldPoint);
            
            const torque = new CANNON.Vec3(5 + powerBarValue * 5, 0, 0);
            bottlePhysicsBody.applyTorque(torque);

            setTimeout(checkLanding, 3000);
        }

        function checkLanding() {
            if (gameState !== 'throwing') return;

            const velocity = bottlePhysicsBody.velocity.length();
            const angularVelocity = bottlePhysicsBody.angularVelocity.length();

            if (velocity < 0.1 && angularVelocity < 0.5) {
                gameState = 'landed';
                const upVector = new CANNON.Vec3(0, 1, 0);
                const bottleUp = bottlePhysicsBody.quaternion.vmult(upVector);
                const angleWithUp = bottleUp.dot(upVector);

                if (angleWithUp > 0.98) {
                    showMessage("–û—Ç–ª–∏—á–Ω–æ!", 2000);
                    addCoins(10);
                } else if (angleWithUp < -0.98) {
                    showMessage("–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ! –ù–∞ –∫—Ä—ã—à–∫—É!", 3000);
                    addCoins(100);
                } else {
                    showMessage("–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!", 2000);
                }
            } else {
                setTimeout(checkLanding, 1000);
            }
        }
        
        function resetBottle() {
            gameState = 'ready';
            hand.visible = true;
            
            hand.add(bottle);
            bottle.position.set(0, 0.5, 0);
            bottle.rotation.set(0, 0, 0);

            bottlePhysicsBody.position.copy(hand.position);
            bottlePhysicsBody.position.y += 0.5;
            bottlePhysicsBody.velocity.set(0, 0, 0);
            bottlePhysicsBody.angularVelocity.set(0, 0, 0);
            bottlePhysicsBody.quaternion.setFromEuler(0, 0, 0);
        }
        
        function updatePowerBar() {
            if (gameState !== 'ready') {
                document.getElementById('power-bar-slider').style.transform = `translateX(-100%)`;
                trajectoryLine.visible = false;
                return;
            }
            
            powerBarValue += powerBarDirection * powerBarSpeed;
            if (powerBarValue > 1 || powerBarValue < 0) {
                powerBarDirection *= -1;
                powerBarValue = Math.max(0, Math.min(1, powerBarValue));
            }
            
            const slider = document.getElementById('power-bar-slider');
            slider.style.transform = `translateX(${(powerBarValue * 2 - 1) * 50}%)`;
            
            bottle.rotation.x = -powerBarValue * bottleSwayFactor;
            water.rotation.x = powerBarValue * bottleSwayFactor * 2;
            
            updateTrajectoryLine();
            trajectoryLine.visible = true;
        }
        
        function updateTrajectoryLine() {
            const forceMagnitude = 2 + powerBarValue * 3;
            const angle = Math.PI / 4;
            const initialVelocity = new THREE.Vector3(0, Math.sin(angle) * forceMagnitude, -Math.cos(angle) * forceMagnitude);
            const initialPosition = new THREE.Vector3().copy(bottlePhysicsBody.position);
            
            const positions = trajectoryLine.geometry.attributes.position.array;
            const timeStep = 0.03;
            
            for (let i = 0; i < 10; i++) {
                const t = i * timeStep;
                const x = initialPosition.x + initialVelocity.x * t;
                const y = initialPosition.y + initialVelocity.y * t - 0.5 * 9.82 * t * t;
                const z = initialPosition.z + initialVelocity.z * t;
                positions[i * 3] = x;
                positions[i * 3 + 1] = y;
                positions[i * 3 + 2] = z;
            }
            for (let i = 10; i < 20; i++) {
                 positions[i * 3] = positions[9 * 3];
                 positions[i * 3 + 1] = positions[9 * 3 + 1];
                 positions[i * 3 + 2] = positions[9 * 3 + 2];
            }
            
            trajectoryLine.geometry.attributes.position.needsUpdate = true;
        }

        // --- –§–£–ù–ö–¶–ò–ò UI –ò –ú–ê–ì–ê–ó–ò–ù–ê ---

        function addCoins(amount) {
            coins += amount;
            updateCoinDisplay();
            saveGameData();
        }

        function updateCoinDisplay() {
            document.getElementById('coin-display').innerText = `üí∞ ${coins}`;
        }
        
        function showMessage(text, duration) {
            const box = document.getElementById('message-box');
            box.innerText = text;
            box.style.opacity = '1';
            setTimeout(() => {
                box.style.opacity = '0';
            }, duration);
        }
        
        function toggleShop() {
            const modal = document.getElementById('shop-modal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
            if(modal.style.display === 'block') {
                populateShop();
            }
        }
        
        function populateShop() {
            const content = document.getElementById('shop-content');
            content.innerHTML = '';
            
            addShopSection('–°–∫–∏–Ω—ã –¥–ª—è –±—É—Ç—ã–ª–∫–∏', 'skins', shopItems.skins, buyItem);
            addShopSection('–õ–æ–∫–∞—Ü–∏–∏', 'locations', shopItems.locations, buyItem);
            addShopSection('–ú—É–∑—ã–∫–∞', 'music', shopItems.music, buyItem);
        }
        
        function addShopSection(title, category, items, buyCallback) {
            const content = document.getElementById('shop-content');
            const section = document.createElement('div');
            section.className = 'col-span-1 md:col-span-2';
            section.innerHTML = `<h3 class="text-xl font-bold border-b-2 border-gray-500 mb-2">${title}</h3>`;
            content.appendChild(section);

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item bg-gray-700 p-4 rounded-lg flex justify-between items-center';
                
                const isPurchased = userItems[category].includes(item.id);
                const isEquipped = activeItems[category] === item.id;

                let buttonHtml;
                if (isEquipped) {
                    buttonHtml = `<button class="equipped" disabled>–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ</button>`;
                } else if (isPurchased) {
                    buttonHtml = `<button onclick="window.equipItem('${category}', '${item.id}')">–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å</button>`;
                } else {
                    buttonHtml = `<button onclick="window.buyItem('${category}', '${item.id}', ${item.price})">–ö—É–ø–∏—Ç—å (${item.price}üí∞)</button>`;
                }

                itemDiv.innerHTML = `
                    <span>${item.name}</span>
                    ${buttonHtml}
                `;
                content.appendChild(itemDiv);
            });
        }

        window.buyItem = (category, itemId, price) => {
            if (coins >= price) {
                coins -= price;
                userItems[category].push(itemId);
                updateCoinDisplay();
                populateShop();
                saveGameData();
                showMessage("–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞!", 1500);
            } else {
                showMessage("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!", 1500);
            }
        }
        
        window.equipItem = (category, itemId) => {
            activeItems[category] = itemId;
            
            if (category === 'skins' && bottleBody) {
                const skin = shopItems.skins.find(s => s.id === itemId);
                if (skin) bottleBody.material.color.set(skin.color || 0xadd8e6);
            } else if (category === 'locations') {
                const location = shopItems.locations.find(l => l.id === itemId);
                if (location) {
                    document.body.style.background = location.background;
                    createPlatforms(itemId);
                }
            } else if (category === 'music') {
                playMusic(itemId);
            }
            
            populateShop();
            saveGameData();
        }
        
        // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---
        async function saveGameData() {
            if (!userDocRef) return;
            const dataToSave = {
                coins,
                userItems,
                activeItems
            };
            try {
                await setDoc(userDocRef, dataToSave);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ", e);
            }
        }

        // --- –ú–£–ó–´–ö–ê ---
        function playMusic(trackId) {
            if (!musicTracks || !musicTracks[trackId]) return;

            if (currentLoop) {
                currentLoop.stop(0);
                currentLoop.dispose();
            }
            if (music) {
                music.dispose();
            }

            music = musicTracks[trackId]();
            
            const notes = trackId === 'synthwave' 
                ? ["C2", "E2", "G2", "B2", "C3", "B2", "G2", "E2"]
                : ["C4", "E4", "G4", "C5", "G4", "E4"];
            
            currentLoop = new Tone.Sequence((time, note) => {
                music.triggerAttackRelease(note, "8n", time);
            }, notes, "4n").start(0);

            Tone.Transport.bpm.value = trackId === 'synthwave' ? 100 : 80;
            Tone.Transport.start();
        }

        // --- –¶–ò–ö–õ –ê–ù–ò–ú–ê–¶–ò–ò ---
        function animate() {
            requestAnimationFrame(animate);
            world.step(1 / 60);
            updatePowerBar();

            if (gameState === 'throwing' || gameState === 'landed') {
                bottle.position.copy(bottlePhysicsBody.position);
                bottle.quaternion.copy(bottlePhysicsBody.quaternion);
            }
            
            renderer.render(scene, camera);
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- –ó–ê–ü–£–°–ö –ò–ì–†–´ ---
        window.onload = () => {
            init();
        };

    </script>
</body>
</html>
